(function($){'use strict';$(document).ready(function(){initCurrencySwitcher();});function initCurrencySwitcher(){$('.wvp-currency-switcher input[name="wvp_currency"]').on('change',function(){handleCurrencyChange($(this));});applySavedCurrencyPreference();}function handleCurrencyChange($input){var currency=$input.val();var switcher=$input.closest('.wvp-currency-switcher');if (!currency || !['USD','VES'].includes(currency)){console.error('Moneda inválida:',currency);return;}switcher.addClass('loading');saveCurrencyPreference(currency,function(success){switcher.removeClass('loading');if (success){updateCurrencyDisplay(switcher,currency);showMessage('Moneda cambiada a '+currency,'success');setTimeout(function(){location.reload();},500);}else{showMessage('Error al cambiar moneda','error');}});}function saveCurrencyPreference(currency,callback){$.ajax({url: wvp_currency.ajax_url,type: 'POST',data:{action: 'wvp_save_currency_preference',currency: currency,nonce: wvp_currency.nonce},success: function(response){if (response.success){localStorage.setItem('wvp_currency',currency);callback(true);}else{console.error('Error al guardar preferencia:',response.data);callback(false);}},error: function(xhr,status,error){console.error('Error AJAX:',error);callback(false);}});}function updateCurrencyDisplay(switcher,currency){switcher.find('.wvp-currency-option').removeClass('active');switcher.find('input[value="'+currency+'"]').closest('.wvp-currency-option').addClass('active');updatePrices(switcher,currency);}function updatePrices(switcher,currency){var priceUsd=parseFloat(switcher.data('price-usd'));var priceVes=parseFloat(switcher.data('price-ves'));var rate=parseFloat(switcher.data('rate'));if (!priceUsd || !rate){return;}if (!priceVes){priceVes=priceUsd*rate;}switcher.find('.wvp-currency-price').each(function(){var $price=$(this);var $option=$price.closest('.wvp-currency-option');var optionCurrency=$option.find('input[name="wvp_currency"]').val();if (optionCurrency==='USD'){$price.text(formatPrice(priceUsd,'USD'));}else if (optionCurrency==='VES'){$price.text(formatPrice(priceVes,'VES'));}});}function formatPrice(price,currency){if (currency==='USD'){return '$'+parseFloat(price).toFixed(2);}else if (currency==='VES'){return formatVesPrice(price);}return price;}function formatVesPrice(price){var formatted=parseFloat(price).toFixed(2);formatted=formatted.replace(/\B(?=(\d{3})+(?!\d))/g,'.');return 'Bs. '+formatted;}function applySavedCurrencyPreference(){var savedCurrency=localStorage.getItem('wvp_currency');if (savedCurrency && ['USD','VES'].includes(savedCurrency)){$('.wvp-currency-switcher input[value="'+savedCurrency+'"]').prop('checked',true);$('.wvp-currency-switcher input[value="'+savedCurrency+'"]').closest('.wvp-currency-option').addClass('active');}}function showMessage(message,type){$('.wvp-currency-message').remove();var $message=$('<div class="wvp-currency-message wvp-message-'+type+'">'+message+'</div>');$message.css({'position': 'fixed','top': '20px','right': '20px','padding': '10px 15px','border-radius': '4px','color': '#fff','font-weight': 'bold','z-index': '9999','opacity': '0','transition': 'opacity 0.3s ease'});if (type==='success'){$message.css('background-color','#28a745');}else if (type==='error'){$message.css('background-color','#dc3545');}$('body').append($message);setTimeout(function(){$message.css('opacity','1');},100);setTimeout(function(){$message.css('opacity','0');setTimeout(function(){$message.remove();},300);},3000);}$(document).ajaxError(function(event,xhr,settings){if (settings.url && settings.url.includes('wvp_save_currency_preference')){showMessage('Error de conexión. Intente nuevamente.','error');}});function validateCurrencyData(currency){if (!currency){console.error('Moneda no especificada');return false;}if (!['USD','VES'].includes(currency)){console.error('Moneda inválida:',currency);return false;}return true;}if (window.location.search.includes('wvp_debug=1')){console.log('WVP Currency Switcher Debug Mode');console.log('Current currency:',wvp_currency.current_currency);console.log('AJAX URL:',wvp_currency.ajax_url);console.log('Nonce:',wvp_currency.nonce);}})(jQuery);